{% extends "base.html" %}

{% block title %}Manage Access - TradingView Access Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-users-cog me-2"></i>
                    User Access Management
                </h4>
            </div>
            <div class="card-body">
                <form id="accessForm">
                    <!-- Username Input -->
                    <div class="mb-4">
                        <label for="username" class="form-label">
                            <i class="fas fa-user me-2"></i>TradingView Username
                        </label>
                        <input type="text" class="form-control" id="username" name="username" 
                               placeholder="Enter TradingView username" required>
                        <div class="form-text">
                            Enter the exact TradingView username (case-sensitive).
                        </div>
                    </div>

                    <!-- Pine Script IDs -->
                    <div class="mb-4">
                        <label for="pine_ids" class="form-label">
                            <i class="fas fa-code me-2"></i>Pine Script IDs
                        </label>
                        <textarea class="form-control" id="pine_ids" name="pine_ids" rows="3" 
                                  placeholder="PUB;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx,PUB;yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy">{{ default_pine_ids }}</textarea>
                        <div class="form-text">
                            Enter Pine Script IDs separated by commas. Find these in browser developer tools.
                        </div>
                        
                        {% if pine_scripts %}
                            <div class="mt-2">
                                <small class="text-muted">Configured Scripts:</small>
                                <div class="mt-1">
                                    {% for script in pine_scripts %}
                                        <button type="button" class="btn btn-sm btn-outline-secondary me-1 mb-1" 
                                                onclick="addPineId('{{ script.pine_id }}')">
                                            {{ script.name }}
                                        </button>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <button type="button" onclick="performAction('validate')" 
                                    class="btn btn-info w-100" id="validateBtn">
                                <i class="fas fa-check me-2"></i>Validate User
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button type="button" onclick="performAction('check')" 
                                    class="btn btn-secondary w-100" id="checkBtn">
                                <i class="fas fa-search me-2"></i>Check Access
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button type="button" onclick="performAction('grant')" 
                                    class="btn btn-success w-100" id="grantBtn">
                                <i class="fas fa-plus-circle me-2"></i>Grant Access
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button type="button" onclick="performAction('remove')" 
                                    class="btn btn-danger w-100" id="removeBtn">
                                <i class="fas fa-minus-circle me-2"></i>Remove Access
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Results Section -->
                <div id="resultsSection" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-list-alt me-2"></i>Results
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="resultsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    Instructions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-user me-2"></i>Username Management</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-check text-success me-2"></i><strong>Validate User:</strong> Verify username exists</li>
                            <li><i class="fas fa-search text-secondary me-2"></i><strong>Check Access:</strong> View current permissions</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cog me-2"></i>Access Control</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-plus-circle text-success me-2"></i><strong>Grant Access:</strong> Add user permissions</li>
                            <li><i class="fas fa-minus-circle text-danger me-2"></i><strong>Remove Access:</strong> Revoke user permissions</li>
                        </ul>
                    </div>
                </div>
                
                <div class="mt-3 p-3 bg-dark rounded">
                    <h6><i class="fas fa-code me-2"></i>Finding Pine Script IDs</h6>
                    <p class="mb-2 small">To find Pine Script IDs:</p>
                    <ol class="small mb-0">
                        <li>Open your TradingView script page</li>
                        <li>Open browser Developer Tools (F12)</li>
                        <li>Look for requests containing "PUB;" followed by a 32-character ID</li>
                        <li>Copy the full ID including "PUB;" prefix</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addPineId(pineId) {
    const textarea = document.getElementById('pine_ids');
    const currentValue = textarea.value.trim();
    
    if (currentValue === '') {
        textarea.value = pineId;
    } else {
        // Check if ID already exists
        if (!currentValue.includes(pineId)) {
            textarea.value = currentValue + ',' + pineId;
        }
    }
    
    // Focus back to textarea
    textarea.focus();
}

function performAction(action) {
    const username = document.getElementById('username').value.trim();
    const pineIds = document.getElementById('pine_ids').value.trim();
    
    if (!username) {
        showAlert('Username is required', 'danger');
        return;
    }
    
    if (!pineIds && action !== 'validate') {
        showAlert('Pine Script IDs are required for this action', 'danger');
        return;
    }
    
    // Disable the button and show loading
    const btnId = action + 'Btn';
    const button = document.getElementById(btnId);
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
    
    // Prepare form data
    const formData = new FormData();
    formData.append('action', action);
    formData.append('username', username);
    formData.append('pine_ids', pineIds);
    
    // Make AJAX request
    fetch('/manage', {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Network response was not ok');
    })
    .then(data => {
        // Display the message from server
        showAlert(data.message, data.type);
        
        // Show results section with data
        showResults(action, username, pineIds, data);
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while processing the request', 'danger');
    })
    .finally(() => {
        // Re-enable button
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function showAlert(message, type) {
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.custom-alert');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create new alert
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show custom-alert`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert at the top of the form
    const form = document.getElementById('accessForm');
    form.parentNode.insertBefore(alert, form);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function showResults(action, username, pineIds, data) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    
    let content = '';
    
    switch(action) {
        case 'validate':
            content = `
                <p><strong>Username Validation:</strong> ${username}</p>
                ${data.data && data.data.validuser ? 
                    `<p class="text-success">✓ Valid username: ${data.data.verifiedUserName}</p>` : 
                    `<p class="text-warning">⚠ Username not found</p>`
                }
            `;
            break;
        case 'check':
            content = `
                <p><strong>Access Check:</strong> ${username}</p>
                <p><strong>Pine IDs:</strong> ${pineIds}</p>
                ${data.data ? `<p class="text-info">Checked ${data.data.length} script(s)</p>` : ''}
            `;
            break;
        case 'grant':
            content = `
                <p><strong>Access Granted:</strong> ${username}</p>
                <p><strong>Pine IDs:</strong> ${pineIds}</p>
                ${data.data ? `
                    <div class="mt-2">
                        ${data.data.map(item => `
                            <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                                <span class="text-monospace small">${item.pine_id}</span>
                                <span class="badge bg-${item.status.includes('Success') ? 'success' : 'danger'}">${item.status}</span>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            break;
        case 'remove':
            content = `
                <p><strong>Access Removed:</strong> ${username}</p>
                <p><strong>Pine IDs:</strong> ${pineIds}</p>
                ${data.data ? `<p class="text-info">Processed ${data.data.length} script(s)</p>` : ''}
            `;
            break;
    }
    
    resultsContent.innerHTML = content;
    resultsSection.style.display = 'block';
}
</script>
{% endblock %}
